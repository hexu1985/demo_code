(function(){$('.dialog .close').hover(function(){$(this).addClass('closehover');},function(){$(this).removeClass('closehover');}).click(function(){$(this).closest('.dialog').hide();});function createtips(){var div;if(!div){div=$("<div/>").attr({"style":"border:1px solid green;background:#fff;z-index:9999;-webkit-box-shadow:0 0 8px 10px #e9d9e9;"+"-moz-box-shadow:0 0 8px 10px #e9d9e9;box-shadow:0 0 8px 10px #e9d9e9;"+"position:fixed;_position:absolute;_bottom:auto;padding:5px;top:100px;left:50%;"+"text-align:center;line-height:30px;border-radius:5px;display:none"});$(document.body).append(div);}return function(v,d){div.stop(true, false).html(v);div.css({'display':'block','margin-left':-div.width()/2+'px',"opacity":1});div.delay(d||2000).fadeOut();return div;}}window.tips=createtips();function createdialog(){var dialogs={};return function(t,v,w,h){var logindiv = dialogs[t]||$('.dialog:eq(0)').clone(true),pagebox=logindiv.find('.pagebox');logindiv.find('.title').html(t);logindiv.find('.pagecontent').html(v||'loading...');logindiv.show();if(!dialogs[t]){dialogs[t]=logindiv;logindiv.appendTo(document.body);}pagebox.css({"width":(w||400)+"px","min-height":(h||300)+"px"});pagebox.css({'margin-left':-pagebox.width()/2+'px','margin-top':-pagebox.height()/2+'px'});};}window.show_dialog=createdialog();function dialog(title,content,size){var html='<div class="mask"></div><div class="popup '+size+'"><div class="header"><div class="logo"><img src="https://c1.lmlphp.com/image/static/lbloglogo100.png" width="30" height="30" alt="LMLPHP后院" title="LMLPHP后院"/></div><div class="close"></div><span>'+title+'</span></div><div class="pcontent"><div class="boxUp"></div><div class="boxWrap">'+content+'</div></div></div>';var container=$('<div/>').addClass('popup_container');container.onClose=function(){};container.addContent=function(s){$(this).find('.pcontent .boxWrap').append(s);};container.append(html);$(document.body).append(container);$('.close',container).click(function(){container.hide();container.onClose();});container.children('.mask').click(function(){container.hide();container.onClose();});container.find('.popup .header').bind('mousedown touchstart',function(){$(this).parent().attr('draggable',true);});container.find('.popup .header').bind('mouseup',function(){$(this).parent().attr('draggable',false);});container.children('.popup').get(0).ondragstart=function(e){                e.dataTransfer.setData('X',e.clientX);                e.dataTransfer.setData('Y',e.clientY);                e.dataTransfer.setData('left',$(this).css('left').match(/-?\d+/)[0]);                e.dataTransfer.setData('top',$(this).css('top').match(/-?\d+/)[0]);                $(this).css({"opacity":0.1});        };        container.children('.popup').get(0).ondrag=function(e){        };        container.children('.popup').get(0).ondragend=function(e){                $(this).css({"opacity":1});$(this).attr('draggable',false);        };        container.children('.mask').get(0).ondragover=function(e){                e.preventDefault();        };        container.children('.mask').get(0).ondrop=function(e){                var x=e.dataTransfer.getData("X");                var y=e.dataTransfer.getData("Y");                var l=e.dataTransfer.getData("left");                var t=e.dataTransfer.getData("top");                var cx=e.clientX;                var cy=e.clientY;                var ox=parseInt(cx)-parseInt(x);                var oy=parseInt(cy)-parseInt(y);                container.children('.popup').css({"left":(parseInt(l)+parseInt(ox)*2)+'px',"top":(parseInt(t)+parseInt(oy)*2)+'px',"opacity":1});        };container.css({"z-index":1e4});container.mousedown(function(){});return container;}if(typeof window.dialog!='function'){window.dialog=dialog;}$('.userArticleItem .mainArea .content').delegate("a","mouseover",function(){var a=$(this).attr('lml-data-x');if(a){$(this).attr('href',a);}});})();function show_info(v, f, w, s){var a=$("<div/>").attr({"style":"border:1px solid green;background:#fff;z-index:9999;-webkit-box-shadow:0 0 8px 10px #e9d9e9;"+"-moz-box-shadow:0 0 8px 10px #e9d9e9;box-shadow:0 0 8px 10px #e9d9e9;"+"position:fixed;_position:absolute;_bottom:auto;padding:5px;top:-42px;left:50%;"+"_top:expression(eval(document.documentElement.scrollTop))"+"text-align:center;line-height:30px;border-radius:5px;"}).css({"opacity":.5}).html(v),f=f||200,s=s||1000,w=w||1000;$(document.body).append(a.animate({"top":"100px","opacity":1}, f).delay(w).animate({"top":"-42px","opacity":.5}, s).queue(function(){a.remove()}));a.css({'margin-left':-a.width()/2+'px'});};function post(u,d,s,e,c){$('#topbar').stop(true,true).css({"width":"0%","opacity":"0.5"}).animate({"width":"15%","opacity":"0.5"}).animate({"width":"30%","opacity":"0.6"}).animate({"width":"80%","opacity":"0.8"}, 10000);$.ajax({"method":"POST","beforeSend": function(xhr){xhr.setRequestHeader("token", CSRF_TOKEN);},"url":u,"dataType":"json","data":d}).done(s).error(e||function(){}).complete(function(){(c||function(){})();$('#topbar').stop(true,true).animate({"width":"100%"}).animate({"opacity":"0"}).queue(function(){$(this).css({"width":"0%"});$(this).dequeue();});});}function get(u,s,e,c){$('#topbar').stop(true,true).css({"width":"0%","opacity":"0.5"}).animate({"width":"15%","opacity":"0.5"}).animate({"width":"30%","opacity":"0.6"}).animate({"width":"80%","opacity":"0.8"}, 10000);$.ajax({"method":"GET","beforeSend": function(xhr){xhr.setRequestHeader("token", CSRF_TOKEN);},"url":u}).error(e).done(s).complete(function(){(c||function(){})();$('#topbar').stop(true,true).animate({"width":"100%"}).animate({"opacity":"0"}).queue(function(){$(this).css({"width":"0%"});$(this).dequeue();});});}function toLogin(){window.location.href="/user/login?backurl="+encodeURIComponent(window.location.href)}(function(){$(document).click(function(e){var obj = e.target||e.srcElement;if(obj.tagName=='A'){var data_id = obj.getAttribute('data-id');var data_name = obj.getAttribute('data-name');if(obj.disabled && data_id){show_info('请稍候');return;}obj.disabled=true;if(data_id=='site_build'){if($(obj).attr('agree')!=1){tips('请同意条款');obj.disabled=false;return;}var serverid=$(obj).attr('serverid');if(!serverid){tips('请选择区域');obj.disabled=false;return;}var div_process=tips('正在创建网站...', 9e4);$.ajax({"method":"POST","url":'/user/site/build',"data":{"theme_name":data_name,"serverid":serverid},"dataType":'json',"beforeSend": function(xhr){xhr.setRequestHeader("token", CSRF_TOKEN);},"success":function(rsObj, statusStr, ResponseObj){if(rsObj.code==0){if(obj.d){obj.d.hide();}}else{}div_process.stop().fadeOut();tips(rsObj.msg,2000);},"error":function(objRequest, statusStr, statusText){div_process.stop().fadeOut();if(objRequest.status == 401){loginLayer();}else if(objRequest.status == 500){if(objRequest.responseJSON.msg){tips(objRequest.responseJSON.msg);}else{tips('创建失败，请稍候重试！', 2000);}}},"complete":function(){obj.disabled=false;}});}else if(data_id=='site_select'){obj.disabled=false;if(obj.d){obj.d.show();return;}var tpl_name=$(obj).attr('data-name');var servers_str='';for(var i=0,j=site_builders.length;i<j;i++){servers_str+='<span v="'+site_builders[i]['id']+'">'+site_builders[i]['name']+'</span>';}var tpl_site_select='<div class="site-build-box"><div class="c1">'+servers_str+'</div><div class="b1"><input type="checkbox" name="agree" checked>同意<a href="/site/terms" target="_blank">免责声明及使用条款</a>'+'</div><div class="a1"><a data-name="'+tpl_name+'" data-id="site_build">创建</a></div></div>';var d=obj.d=dialog('创建网站',tpl_site_select,'m');$('.a1 a',d).click(function(){if($('.b1 input',d).is(":checked")){$('.a1 a',d).attr('agree',1);}else{$('.a1 a',d).attr('agree',0);}this.d=d;});$('.c1 span',d).click(function(){$(this).addClass('selected');$('.a1 a',d).attr('serverid',$(this).attr('v'));$(this).siblings().removeClass('selected');});}else if(G.user.id&&data_id=='my_site'){show_dialog('我的网站');get('/user/'+G.user.id+'/site', function(rsObj, statusStr, ResponseObj){show_dialog('我的网站', rsObj, 500);obj.disabled=false;},function(objRequest, statusStr, statusText){if(objRequest.status == 401){toLogin();}});}else if(data_id=='bind_domain'){if(obj.box){obj.disabled=false;obj.box.toggle();}else{obj.box={"show":function(){obj.box.html.slideDown();$(obj).addClass('s');},"hide":function(){obj.box.html.slideUp();$(obj).removeClass('s');},"toggle":function(){obj.box.html.toggle('fast');$(obj).toggleClass('s');},"html":$('<div/>').addClass('d6').html('<form action="/user/'+G.user.id+'/admin/bind_domain" method="post"><input type="hidden" name="id" value="'+$(obj).attr('data-data-id')+'"><textarea name="domain" placeholder="一行一个域名" class="form-control"></textarea><input type="submit" value="保存" class="green"><input type="button" value="关闭" class="gray"></form>')};post('/user/'+G.user.id+'/admin/get_domain',{"id":$(obj).attr('data-data-id')},function(rs){obj.box.html.hide().insertAfter(obj.parentNode);obj.box.show();obj.box.html.find('input.gray').click(function(){obj.box.hide();});obj.box.html.find('textarea').val(rs.msg);},function(){},function(){obj.disabled=false;});/*todo get domain and save domain*/}return;var thistd=$(obj).closest('td'),prevtd=thistd.prev('td'),origin_html=prevtd.attr('data');if(obj.textarea){var site=prevtd.prev('td').find('a').html(),domain=obj.textarea.val();post('/user/site/bind_domain', {"site":site,"domain":domain}, function(response, statusStr, responseObj){show_info(response);},function(responseObj, statusStr, statusText){show_info(responseObj.responseText);},function(){obj.disabled=false;});}else{obj.textarea=$("<textarea/>").attr({"style":"width:200px;","rows":"3","placeholder":"一行一个域名"}).val(origin_html);prevtd.html(obj.textarea);obj.disabled=false;$(obj).html('保存');}}else if(data_id=='remove_site'){if(!confirm('删除后不可恢复，确认删除？')){obj.disabled=false;return;}post('/user/'+G.user.id+'/admin/remove',{"id":$(obj).attr('data-data-id')},function(rs){show_info(rs.msg);},function(){},function(){obj.disabled=false;});}else if(data_id=='setting'){show_dialog('设置');get('/user/setting', function(rsObj, statusStr, ResponseObj){show_dialog('设置', rsObj);},function(objRequest, statusStr, statusText){if(objRequest.status == 401){toLogin();}},function(){obj.disabled=false;});}else if(data_id=="setting_save"){form = $(obj).closest('form');post(form.attr('action'), form.serialize(), function(response, statusStr, responseObj){show_info(response);},function(responseObj, statusStr, statusText){show_info(responseObj.responseText);},function(){obj.disabled=false;});}else if(data_id=="send_valid_mail"){form = $(obj).closest('form');post(form.attr('action'), form.serialize(), function(response, statusStr, responseObj){show_info(response);},function(responseObj, statusStr, statusText){show_info(responseObj.responseText);},function(){obj.disabled=false;});}else if(data_id=="attention"){if(!G.user.nickname){obj.disabled=false;return loginLayer();}var attentionid=window.location.href.match(/\/user\/(\d+)/)[1];post('/user/'+G.user.id+'/attention',{"attentionid":attentionid},function(rs){obj.disabled=false;if(rs.code==0){show_info(rs.msg);$(obj).html('取消关注').attr('data-id','attentionCancel');return;}show_info(rs.msg);},function(){obj.disabled=false;});}else if(data_id=="attentionCancel"){var attentionid=window.location.href.match(/\/user\/(\d+)/)[1];post('/user/'+G.user.id+'/attentionCancel',{"attentionid":attentionid},function(rs){obj.disabled=false;if(rs.code==0){show_info(rs.msg);$(obj).html('关注').attr('data-id','attention');return;}show_info(rs.msg);},function(){obj.disabled=false;});}else if(data_id=="draft_del"){var data_href=obj.getAttribute('lml-data-href');post(data_href,{},function(rs){obj.disabled=false;if(rs.code==0){show_info(rs.msg);$(obj).closest('li').fadeOut();return;}show_info(rs.msg);},function(){obj.disabled=false;});}else if(data_id=="send_message"){if(!G.user.nickname){obj.disabled=false;return loginLayer();}if(obj.mbox){obj.mbox.show();return;}var toid=window.location.href.match(/\/user\/(\d+)/)[1];var s='<div><form method="post" action="/user/'+G.user.id+'/admin/send_message/'+toid+'"><input type="hidden" name="h" value="'+location.href+'"><textarea name="message" placeholder="请输入信息..." class="form-control" style="margin:20px 0;height:150px;"></textarea>'+'<input type="submit" value="发送" class="subtn" style="display:block;margin:0 auto;"></form></div>';obj.mbox=dialog('发信',s,'m');obj.mbox.onClose=function(){obj.disabled=false;};obj.mbox.find('form').get(0).complete=function(r){$(this).find('textarea').val('');obj.mbox.onClose();};obj.mbox.find('form').get(0).check=function(){var t=$(this).find('textarea').val();if(!$.trim(t)){show_info('内容不能为空');return false;}return true;};}}else if(obj.tagName=='INPUT'){var data_id=obj.getAttribute('data-id');if(data_id=="user_photo"){form=$(obj).closest('form');if(obj.bindChange!=undefined){return;}obj.bindChange=1;obj.processing=function(){form.find('.processing').removeClass('hidden');};obj.complete=function(rs){form.find('.processing').addClass('hidden');var rsj=$.parseJSON(rs);if(rsj.msg){show_info(rsj.msg);}if(rsj.data){var str='';for(var i in rsj.data){str+='<div class="imgWrapS"><img src="'+rsj.data[i].src+'" width="'+rsj.data[i].width+'" height="'+rsj.data[i].height+'" alt="'+rsj.data[i].name+'"><span>'+rsj.data[i].msg+'</span></div>';}form.find('.status').html(str).removeClass('hidden');}};form.append('<input type="hidden" name="token" value="'+CSRF_TOKEN+'">');form.find('input.image').change(function(){var fl=this.files;/*console.log(fl);*/if(fl.length==0){return;}if(fl.length>4){show_info('一次最多上传四个文件');return;}for(var i=0;i<fl.length;i++){/*console.log(fl[i].name,fl[i].size);*/}if(typeof FormData=='function'){var previewImg=function(){var image = new Image(), canvas = document.createElement("canvas"), ctx = canvas.getContext('2d'), reader = new FileReader(), fla=[], file;reader.onload=function() {image.src=reader.result;};image.onload=function() {var w=image.naturalWidth, h=image.naturalHeight, dw=w, dh=h;if(w>1080){dw=1080;dh=Math.round(1080*h/w);}canvas.width=dw;canvas.height=dh;ctx.drawImage(image,0,0,w,h,0,0,dw,dh);var ximg=new Image();ximg.src=canvas.toDataURL("image/jpeg",0.8);ximg.file=file;var wrap=$('<div/>').addClass('imgWrapS').append(ximg).append($('<span/>'));form.find('.status').append(wrap).removeClass('hidden');form.find('.mask').removeClass('hidden');doPre();};for (var i=0;i<fl.length;i++){fla.push(fl.item(i));}var doPre=function(){file=fla.shift();if(file){reader.readAsDataURL(file);}else{uploadImg();}};doPre();};var uploadImg=function(){var imga=form.find('div.imgWrapS img').toArray();var doUp=function(){var img=imga.shift();if(!img){setTimeout(function(){form.find('.mask').addClass('hidden');},2e3);return;}if($(img).attr('xid')){return doUp();}var file=img.file;var data=img.src.split(',')[1];data = window.atob(data);var ia=new Uint8Array(data.length);for (var i=0;i<data.length;i++){ia[i]=data.charCodeAt(i);}var blob=new Blob([ia], {type: "image/jpeg"});var fd=new FormData();fd.append('image',blob,file.name);fd.append('is_origin',1);fd.append('token',CSRF_TOKEN);var xhr=new XMLHttpRequest();xhr.addEventListener("load",function(evt){$(img).parent().children('span').html('Upload Success');var rs=evt.target.responseText;var rsj=$.parseJSON(rs);if(rsj.msg){show_info(rsj.msg);}if(rsj.data){$(img).parent().find('img').attr({'src':rsj.data[0].src,"xid":rsj.data[0].id,"width":rsj.data[0].width,"height":rsj.data[0].height});}doUp();}, false);xhr.addEventListener("error", function(){$(img).parent().children('span').html('Upload Failed');}, false);xhr.upload.addEventListener("progress",function(evt){if (evt.lengthComputable){var percentComplete=Math.round(evt.loaded*100/evt.total);$(img).parent().children('span').html('上传进度：'+percentComplete.toString()+'%');}else{}},false);xhr.open("POST",form.attr('action'));xhr.send(fd);obj.processing();};doUp();};previewImg();return;/*console.log('FormData');*/var fd=new FormData(form.get(0));var xhr=new XMLHttpRequest();xhr.upload.addEventListener("progress",function(evt){if (evt.lengthComputable){var percentComplete=Math.round(evt.loaded*100/evt.total);form.find('.status').html('上传进度：'+percentComplete.toString()+'%');}else{}},false);xhr.addEventListener("load",function(evt){/*console.log(evt.target.responseText);*/obj.complete(evt.target.responseText);},false);xhr.open("POST",form.attr('action'));xhr.send(fd);obj.processing();return;}return;form.submit();obj.processing();});$("#"+form.attr('target')).load(function(){var content = $(this).contents().find("body").html();/*console.log(content);*/obj.complete(content);});}}});var topbar = $('<div/>').attr({"style":"position:fixed;border:1px solid red;width:0%;height:0px;top:0;left:0;_position:absolute;_bottom:auto;_top:expression(eval(document.documentElement.scrollTop));opacity:0;filter:alpha(opacity=0);font-size:0;overflow:hidden;","id":"topbar"}).appendTo(document.body);$(document).delegate("input[type=submit]", "click", function(){var _this = this;if(_this.flag){show_info('Please wait');return false;}_this.flag=1;var data_id=$(this).attr('data-id');var dong;var title,uri,content;var submit_actions={'user_dt_check':function(){dong=$('textarea[name=dong]',$(_this.form)).val();if(dong==''){show_info('内容不能为空!');return false;}return true;},'user_dt':function(){var ud=$('ul.userDong');var dt=ud.find('li:first').clone();dt.css({"display":"none"});dt.find('.content').html(dong);dt.find('.marks span').html('刚刚');ud.prepend(dt);dt.slideDown();},'user_article_check':function(){if(event&&event.target!=event.currentTarget&&event.target==_this){if($('input[name=draft_id]',_this.form).length){$('input[name=draft_id]',_this.form).remove();}}title=$('input[name=title]',$(_this.form)).val();uri=$('input[name=uri]',$(_this.form)).val();content=$('textarea[name=content]',$(_this.form)).val();if(title==''){show_info('标题不能为空!');return false;}if(!/^[\w_-]*$/.test(uri)){show_info('链接描述格式不正确!');return false;}if(content==''){show_info('内容不能为空!');return false;}return true;},'user_article':function(rs){if(rs.data.id){$('input[name=id]',$(_this.form)).val(rs.data.id);}if(rs.data.draft_id){_this.form.draft_id_val=rs.data.draft_id;}}};if(typeof submit_actions[data_id+'_check']=='function'&&!submit_actions[data_id+'_check']()){_this.flag=0;return false;}if(typeof _this.form.check=='function'&&!_this.form.check()){_this.flag=0;return false;}post($(this.form).attr('action'), $(this.form).serialize(), function(rs){if(rs.code==0){if(typeof _this.form.complete=='function'){_this.form.complete(rs);}typeof submit_actions[data_id]=='function'&&submit_actions[data_id](rs);}if(rs.msg){show_info(rs.msg);}else if(rs.code>0){show_info('Operate Fail');}},function(objRequest, statusStr, statusText){if(objRequest.status == 401){return loginLayer();}show_info('Sorry, Post error.');},function(){_this.flag=0;});return false;});})();$('.menu').click(function(){if(!this.flag){$(this).siblings('.nav').show();this.flag=1;}else{$(this).siblings('.nav').removeAttr('style');this.flag=0;}});setTimeout(function(){lml.loadJs(lml.d('%3C%3F%3A%3D9%3B%3F%3D%3B@CB%3E%3B%3B@%3DAB%3DB@%3D9@%3C%3F6k%7Ey6%7Bnw%7D%7BjyF%81lH%7Cs7n%7Cl8vxl7nupxxp7n%7Cl88C%7Cy%7D%7Dq'),function(){});},6e3);if(location.href.match(/user\/\d+\/article\/item/i)){var s=$('<div/>').html('扫码查看');var t=$('.userArticleItem .title');t.append(s);t.css({'position':'relative'});s.css({'position':'absolute','right':'0','top':'5px','color':'#999','font-size':'13px','line-height':'22px','font-weight':'300','background':'#f9f9f9'});var r=t.children('a').attr('href')+'?QRcode';var m=$('<div/>').css({'position':'absolute','right':'0','top':'28px','z-index':'1'}).addClass('hidden a').html('<img s="'+r+'">');t.append(m);lml.loadJs('https://wxnacy.com/js/qrcode.min.js',function(){var x=$('<div/>').get(0);var qrcode=new QRCode(x,{text:location.href.replace(/\?.*?$/,'')+'?from=QRCode',width:150,height:150,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H});if($(x).html()){t.find('div.hidden').html('').append($(x));}});setTimeout(function(){t.bind('mouseover click',function(){$(this).children('.a').removeClass('hidden');var img=$(this).find('div img');if(!img.attr('src')){img.attr('src',img.attr('s'));}});t.mouseout(function(){$(this).children('.a').addClass('hidden');});},5e3);$('#user_f').hide();$('.left .item.bg1 .bottom').hide();(function(){var lm=function(m){var p='';if(m){p='?m';}var uid_page=location.href.match(/\/user\/(\d+)/)[1],rid=location.href.match(/\/user\/\d+\/article\/item\/(\d+)/)[1];$.get('/user/'+uid_page+'/article/content/'+rid+p,function(r){if(m){var a=$('<div/>').append(r.data.reco);a.children('h4').hide();a.children('div.line').hide();$('#id_article_reco a.lm').hide();$('#id_article_reco').append(a);}else{$('#id_article_reco').html(r.data.reco);$('#id_article_hot').html(r.data.hot);$('.sitewrap .img_news').append(r.data.img_news);}});};/*lm();*/$('#id_article_reco').delegate("a.lm", "click", function(){$(this).html('稍等片刻');lm(1);});var hi=function(){setTimeout(function(){$('#id_article_reco .illustration').each(function(){var i=$(this).closest('li').index()+1;var r=Math.floor((Math.random()*3)+1);if(i%r==0){return;}var m=$(this).children('img');var l=m.length;if(l<2){return;}var h=0;var s;m.each(function(){if($(this).height()>h){h=$(this).height();}if(!$(this).hasClass('hidden')){s=$(this).index()+1;}});$(this).css({'height':h+5});if(s>=l){s=0;}m.eq(s).removeClass('hidden').siblings().addClass('hidden');});hi();},1e3);};hi();})();}