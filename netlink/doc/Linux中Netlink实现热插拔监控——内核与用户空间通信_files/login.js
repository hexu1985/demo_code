(function(){function toQzoneLogin(){window.location.href=lml.uhost+"/user/qqlogin?backurl="+encodeURIComponent(window.location.href)}function toWeiboLogin(){window.location.href=lml.uhost+"/user/weibologin?backurl="+encodeURIComponent(window.location.href)}function post(u,d,s,e,c){$.ajax({"method":"POST","beforeSend": function(xhr){xhr.setRequestHeader("token", CSRF_TOKEN);},"url":u,"dataType":"json","data":d}).done(s).error(e||function(){}).complete(function(){(c||function(){})();});}function showInfo(v,f,w,s){var a = $("<div/>").attr({"style":"border:1px solid green;background:#fff;z-index:10002;-webkit-box-shadow:0 0 8px 10px #e9d9e9;"+"-moz-box-shadow:0 0 8px 10px #e9d9e9;box-shadow:0 0 8px 10px #e9d9e9;"+"position:fixed;_position:absolute;_bottom:auto;padding:5px;top:-42px;left:50%;"+"_top:expression(eval(document.documentElement.scrollTop))"+"text-align:center;line-height:30px;border-radius:5px;"}).css({"opacity":.5}).html(v),f=f||200,s=s||1000,w=w||1000;$(document.body).append(a.animate({"top":"100px","opacity":1}, f).delay(w).animate({"top":"-42px","opacity":.5}, s).queue(function(){a.remove()}));a.css({'margin-left': -a.width()/2+'px'});}function dialog(title,content,size){var html='<div class="mask"></div><div class="popup '+size+'"><div class="header"><div class="logo"><img src="'+G.c.cdn_url+'lbloglogo100.png" width="30" height="30" alt="LMLPHP后院" title="LMLPHP后院"/></div><div class="close"></div><span>'+title+'</span></div><div class="pcontent"><div class="boxUp"></div><div class="boxWrap">'+content+'</div></div></div>';var container=$('<div/>').addClass('popup_container');container.onClose=function(){};container.append(html);$(document.body).append(container);$('.close',container).click(function(){container.hide();container.onClose();});$('.mask',container).click(function(){container.hide();container.onClose();});container.mousedown(function(){});return container;}var loginLayer;function toLogin(){if(toLogin.flag){return loginLayer.show();}toLogin.flag=1;var content='<div class="loginLayer"><iframe name="iframeLogin" class="hidden"></iframe><form action="/user/login" method="post" target="iframeLogin"><div class="formbox"><div class="field"><div class="fieldLeft">邮箱</div><div class="fieldRight"><input class="form-control" name="email" type="text"/></div></div><div class="field"><div class="fieldLeft">密码</div><div class="fieldRight"><input class="form-control" name="passwd" type="password"/></div></div><div class="tips"></div><div class="field loginBtn"><input type="hidden" name="type" value="iframe"/><input class="subtn" type="submit" value="登 录"/> <a class="switch register">注册新用户</a> <a class="forget" target="_blank" href="'+lml.uhost+'/user/recover_passwd">忘记密码？</a></div><div class="field third"><div>第三方登录</div><div><div class="logintype"><a href="javascript:void(0)" class="toQzoneLogin hidden"><img alt="Use qq login" title="使用QQ登录" src="'+G.c.cdn_url+'qq_login.png" height="24" width="120"></a></div><div class="logintype"><a href="javascript:void(0)" class="toWeiboLogin"><img alt="Use weibo login" title="使用新浪微博登录" src="'+G.c.cdn_url+'weibo_login.png" height="24" width="120"></a></div></div></div></div></form><form action="/user/register" method="post" target="iframeLogin" class="hidden"><div class="formbox"><div class="field"><div class="fieldLeft">邮箱</div><div class="fieldRight"><input class="form-control" name="email" type="text"/></div></div><div class="field"><div class="fieldLeft">密码</div><div class="fieldRight"><input class="form-control" name="passwd" type="password"/></div></div><div class="field"><div class="fieldLeft">重复密码</div><div class="fieldRight"><input class="form-control" name="repasswd" type="password"/></div></div><div class="captcha"><img alt="点击换一张" title="点击换一张" osrc="/user/register/captcha" onclick="this.src=\'/user/register/captcha?\'+Math.random()"/></div><div class="field"><div class="fieldLeft">验证码</div><div class="fieldRight"><input class="form-control" name="captcha" type="text"/></div></div><div class="tips"></div><div class="loginBtn"><input type="hidden" name="type" value="iframe"/><input class="subtn" type="submit" value="注 册"/>  <a class="switch login">已有账号？登录</a></div></div></form></div>';loginLayer=dialog('加入我们',content,'m');loginLayer.delegate("input[type=submit]", "click", function(){var _this = this;this.disabled = true;var d=lml.createDeferred();d.then(function(){post($(_this.form).attr('action'),$(_this.form).serialize(),function(rs){if(rs.code==0){/*window.location.reload();*/showInfo(rs.msg);loginLayer.hide();G.user=rs.data.user;writeLoginBox();return;}showInfo(rs.msg);_this.disabled = false;$('.tips',_this.form).html(rs.msg);},function(){showInfo('Cause Error.');_this.disabled = false;});});if(!_this._c){$.post('/user/authCheck',{'x':1},function(r){eval(r);d.promise();});}else{d.promise();}});$('a.switch',loginLayer).click(function(){if($(this).hasClass('login')){loginLayer.find('form:eq(0)').removeClass('hidden');loginLayer.find('form:eq(1)').addClass('hidden');}else{loginLayer.find('form:eq(0)').addClass('hidden');loginLayer.find('form:eq(1)').removeClass('hidden');}});$('input[name=captcha]',loginLayer).focus(function(){var captcha=$('.captcha img',loginLayer);if(!captcha.attr('src')){captcha.attr('src',captcha.attr('osrc'));}});var loginCss='.mask{width:100%;height:100%;position:fixed;left:0;top:0;opacity:0.15;filter:alpha(opacity=15);background:#FFF;}.popup{width:100%;height:360px;position:fixed;left:0;top:0;right:0;bottom:0;margin:auto;background:#FFF;opacity:1;filter:alpha(opacity=100);-webkit-box-shadow:0 0 12px 4px #dcdcdc;-moz-box-shadow:0 0 12px 4px #dcdcdc;box-shadow:0 0 12px 4px #dcdcdc;border:1px solid #ddd;}.popup.m{max-width:320px;}.popup.l{max-width:500px;}@media screen and (max-width:320px){.popup{width:96%;}}.popup .header{font-size:16px;height:40px;line-height:40px;background-color:#F7F7F7;position:absolute;width:100%;z-index:1;padding:0;}.popup .header .close{width:18px;height:18px;float:right;margin:9px 9px 0 0;}.popup .header .close{background-image:url('+G.c.cdn_url+'login_icons.png);background-repeat:no-repeat;background-position:-54px -45px;}.popup .header .close:hover{background-image:url('+G.c.cdn_url+'login_icons.png);background-repeat:no-repeat;background-position:-70px -45px;}.popup .header span{padding-left:40px;display:block;text-indent:10px;font-weight:bold;letter-spacing:1px;color:#333;}.popup .header .logo{float:left;position:absolute;left:12px;top:5px;}.popup .pcontent{overflow:auto;height:360px;}.popup .pcontent .boxUp{height:40px;}.popup .pcontent .boxWrap{padding:6px;}.form-control{outline:none;display: block;width: 100%;height: auto;padding: 6px 12px;font-size: 14px;line-height: 1.428571429;color: #555;vertical-align: middle;background-color: #fff;background-image: none;border: 1px solid #ccc;border-radius: 4px;-webkit-box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);box-shadow: inset 0 1px 1px rgba(0,0,0,0.075);-webkit-transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;transition: border-color ease-in-out .15s,box-shadow ease-in-out .15s;box-sizing:border-box;margin-bottom:10px;}.loginLayer{font-size:14px;}.loginLayer .switchtab{width:50%;float:left;text-align:center;}.loginLayer .switch{padding:5px;cursor:pointer;text-decoration:none;}.loginLayer .register,.loginLayer .login{color:#5656EC;}.loginLayer .forget{color:#666;font-size:12px;text-decoration:none;}.loginLayer .switchtab .on{color:red;border-bottom:1px solid #ccc;}.loginLayer .formbox{padding:10px;}.loginLayer .field{margin:6px 0;position:relative;}.loginLayer .tips{color:red;text-align:center;}.loginLayer .captcha{cursor:pointer;text-align:center;font-size:0;}.loginLayer .field .fieldLeft{position:absolute;top:8px;color:gray;}.loginLayer .field .fieldRight{padding-left:64px;}.loginLayer .loginBtn{text-align:center;}.loginLayer .third{line-height:26px;text-align:center;color:gray;}.loginLayer .subtn{outline:none;border:1px solid #ccc;cursor:pointer;height:26px;line-height:26px;padding:0 10px;color:#337ab7;border-radius:5px;background:#FFF;margin:5px 0;-webkit-appearance:none;}.loginLayer .subtn:hover{border:1px solid #ff6f3d;background:#ff6f3d;color:white;}.loginLayer .subtn:active{top:1px;position:relative;}';var style=document.createElement("style");style.type="text/css";if(style.styleSheet){style.styleSheet.cssText=loginCss;} else {style.innerHTML=loginCss;}$(document.body).append(style);return loginLayer;}var showLayer;function showLogin(){showLayer=toLogin();loginLayer.find('form:eq(0)').removeClass('hidden');loginLayer.find('form:eq(1)').addClass('hidden');return showLayer;}function showRegister(){showLayer=toLogin();showLayer.find('form:eq(0)').addClass('hidden');showLayer.find('form:eq(1)').removeClass('hidden');return showLayer;}function writeLoginBox(){var top=$('.top').find('ul').get(0);if(!top){top=$('.header').find('ul').get(0);}if (!top.haslogbox){$(top).append('<li class="fr login"></li>');top.haslogbox=1;}if(G.user.id){var x=lml.uhost;if(G.user.avatar.match(/^http/)){x='';}var html='<img src="'+x+G.user.avatar+'" width="37" height="37" class="avatar" alt="'+G.user.nickname+'" title="'+G.user.nickname+'"/><div class="logbox"><div><span>您好</span><a href="'+lml.uhost+'/user/'+G.user.id+'">'+G.user.nickname+'</a></div><hr><div class="ca"><a href="'+lml.uhost+'/user/'+G.user.id+'/admin/chnick">修改昵称</a></div><div class="lt2"><a href="/user/logout" style="padding:0 3px;color:#004276">退出</a></div></div>';}else{var html='<img alt="请登录" height="37" width="37" class="avatar" src="'+G.c.cdn_url+'default_avatar.gif"/><div class="logbox"><div class="lr"><a href="javascript:showLoginLayer();">登录</a><a href="javascript:showRegisterLayer();">注册</a></div><hr><div class="lt"><a href="javascript:void(0)" class="toQzoneLogin hidden"><img alt="Use qq login" title="使用QQ登录" src="'+G.c.cdn_url+'qq_login.png" height="24" width="120"></a></div><div class="lt2"><a href="javascript:void(0)" class="toWeiboLogin"><img alt="Use weibo login" title="使用新浪微博登录" src="'+G.c.cdn_url+'weibo_login.png" height="24" width="120"></a></div></div>';}var topCss='.top .login{position:relative;font-size:14px;}.top .login .avatar{float:left;margin-top:2px;opacity:.6;}.top .logbox{display:none;border:1px solid #086ed5;width:152px;height:auto;z-index:9;position:absolute;top:39px;right:0;color:#333;background:#fff;text-align:center;line-height:40px;}.top .logbox a{padding:0 3px;color:#004276;font-size:14px;}.top .logbox hr{border:0;margin: 0 16px;border-bottom:1px solid #DFE1E5;}.top .logbox span{padding:0 3px;color:#666;}.top .logbox .lt{line-height:24px;margin-top:14px;}.top .logbox .lt2{line-height:24px;margin-bottom:5px;}.top .logbox .ca{line-height:24px;margin-top:8px;}';var style=document.createElement("style");style.type="text/css";if(style.styleSheet){style.styleSheet.cssText=topCss;} else {style.innerHTML=topCss;}if (!top.hasCss){top.hasCss=1;$(document.body).append(style);$(document).delegate("a.toQzoneLogin", "click", function(e){toQzoneLogin();return false;});$(document).delegate("a.toWeiboLogin", "click", function(e){toWeiboLogin();return false;});$(document).delegate(".top .login", "mouseover", function(){$('.logbox',this).stop().slideDown('fast');});$(document).delegate(".top .login", "mouseout", function(){$('.logbox',this).stop().slideUp('fast');});}$(top).find('.login').html(html);}writeLoginBox();window.loginLayer=toLogin;window.showRegisterLayer=showRegister;window.showLoginLayer=showLogin;window.lml.writeLoginBox=writeLoginBox;})();