$(function(){function o(){var o=setInterval(function(){if(document.getElementById("csdn-toolbar")){clearInterval(o),u=document.getElementById("csdn-toolbar").offsetHeight;var e=document.documentElement.scrollTop||window.pageYOffset||document.body.scrollTop;e-l>0&&e<n-t&&t>0?a.css({position:"fixed","z-index":"999",left:s+"px",top:u,width:i}):a.css({position:"unset","z-index":"10",left:"0px",top:"0",width:i})}},100)}var e=window.location.href;if(e.indexOf("category_")>-1){var a=$("#column .column_info_box"),n=$("#column .column_article_list").height(),t=$("#column .column_article_list li").length?$("#column .column_article_list li").height():0,c=document.getElementsByTagName("main")[0],s=c.offsetLeft,i=c.offsetWidth,l=document.getElementsByTagName("header")[0].offsetHeight,u=0;o(),$(window).scroll(function(){o()}),$(window).resize(function(){s=c.offsetLeft,i=c.offsetWidth,o()})}}),$(function(){function o(){T="https://csdnimg.cn/release/download/images/pay_error.png",N="已扫码<br>请在手机端操作",$("#payCode").html('<div class="renovate"><img src="'+T+'"><span>'+N+"</span></div>"),$("#payCodeImg").html('<img class="repeat-again" src="'+T+'"><span class="text">'+N+"</span>")}function e(e){var s={goods_id:e,product_id:e,flag:17,request_type:4,is_use_balance:x,coupon_key:v,sale_source:_,success_function:a,error_function:t,timeout_function:c,get_pay_success_callback:n,payment_function:o};$("#payCode").html(O),$("#payCodeImg").html(z),cart.qrPay(s)}function a(o,e){I?u("payCode",e.pay_url):u("payCodeImg",e.pay_url),h=e.pay_url}function n(){k.boxshadow.fadeOut(function(){showToast({text:"支付成功",bottom:"10%",zindex:9e3,speed:500,time:1500}),window.location.reload(),k.payCode.fadeOut(function(){window.location.reload()})})}function t(o){showToast({text:o.errorMessage,bottom:"10%",zindex:9e3,speed:500,time:1500})}function c(){I?k.payCode.find("#payCode").html(U):k.getPay.find("#payCodeImg").html(j)}function s(o,e){var a=Number(o)-Number(e);return a>0?a.toFixed(2):a<0?a.toFixed(2):a}function i(o){$.ajax({type:"GET",url:"https://mall.csdn.net/mp/mallorder/api/internal/goods/getGoodsInfo?goods_id="+o+"&product_id="+o+"&flag=17",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(a){y=a.data.available_amount,a.data.coupon_discount&&a.data.coupon_key&&(w=1*a.data.coupon_discount,v=a.data.coupon_key),P++,P<=1&&(0==y?(x=0,$(".pay-code-radio").prop("disabled",!0)):s(E,w)>0?(x=1,$(".pay-code-radio").attr("data-flag","true"),$(".pay-code-radio").prop("checked",!0)):(x=0,$(".pay-code-radio").prop("disabled",!0))),$(".pay-balance .balance").text(y),$(".pay-code-balance .balance").text(y),l(),e(o)}})}function l(){$(".subscribe-available-balance .subscribe-available-balance-t").css({display:"block"}),w?(s(E,w)>0?x?(s(s(E,w),y)>0?($(".available-balance-0").text("¥"+y),$(".available-balance-1").text("¥"+s(s(E,w),y))):($(".available-balance-0").text("¥"+s(E,w)),$(".available-balance-1").text("¥0")),$(".subscribe-price-box").css({display:"none"}),$(".subscribe-available-balance").css({display:"block"})):($(".available-balance-1").text("¥"+s(E,w)),$(".subscribe-price-box").css({display:"none"}),$(".subscribe-available-balance .subscribe-available-balance-t").css({display:"none"}),$(".subscribe-available-balance").css({display:"block"})):($(".available-balance-1").text("¥0"),$(".subscribe-price-box").css({display:"none"}),$(".subscribe-available-balance .subscribe-available-balance-t").css({display:"none"}),$(".subscribe-available-balance").css({display:"block"})),$(".coupons-box .coupons-money").html("¥"+w),$(".coupons-box").fadeIn()):x?(s(E,y)>0?($(".available-balance-0").text("¥"+y),$(".available-balance-1").text("¥"+s(E,y))):($(".available-balance-0").text("¥"+E),$(".available-balance-1").text("¥0")),$(".subscribe-price-box").css({display:"none"}),$(".subscribe-available-balance").css({display:"block"})):($(".now-price").text("¥"+E),$(".subscribe-available-balance").css({display:"none"}),$(".subscribe-price-box").css({display:"block"}))}function u(o,e){var a=qrcode(6,"M");a.addData(e),a.make(),$("#"+o).html(a.createImgTag(3,3)),$("#"+o).html($("#"+o).html()),I&&k.boxshadow.fadeIn(function(){k.payCode.fadeIn()})}function d(){var o=$(this),e=o.data("id");if(o.data("type"))var a=blogUrl+"phoenix/web/v1/subscribe/un-subscribe-study?columnId="+e;else var a=blogUrl+"phoenix/web/v1/subscribe/subscribe-study?columnId="+e;getCookie("UserName")?$.ajax({url:a,type:"post",dataType:"json",xhrFields:{withCredentials:!0},success:function(e){200==e.code&&e.data.status?o.data("type")?(o.parents(".column-group-item").find(".studyvip-unsubscribe").css("display","inline-block"),o.parents(".column-group-item").find(".studyvip-subscribe").css("display","none")):(o.parents(".column-group-item").find(".studyvip-subscribe").css("display","inline-block"),o.parents(".column-group-item").find(".studyvip-unsubscribe").css("display","none")):showToast({text:e.data.msg||"操作失败，请重试！",bottom:"10%",zindex:9e3,speed:500,time:1500})},error:function(o){showToast({text:o.data.msg||"操作失败，请重试！",bottom:"10%",zindex:9e3,speed:500,time:1500})}}):window.csdn.loginBox.show()}function p(o){var e=new RegExp("(^|&)"+o+"=([^&]*)(&|$)","i"),a=window.location.search.substr(1).match(e);return null!=a?unescape(a[2]):""}function r(o){window.csdn&&window.csdn.userOrderPayment&&window.csdn.userOrderPayment.show({params:[{flag:17,goodsId:o,productId:o}]})}function b(o,e){if(o.show){var a='<div class="column_coupon_main '+(o.receive?"active":"")+'">                <img class="column_coupon_icon" src="'+o.activityIcon+'" alt="">                <div class="column_coupon_text">                <span class="column_coupon_l">'+o.couponDesc+'</span>                <span class="column_coupon_m"></span>                <span class="column_coupon_r" data-couponId="'+o.groupNumber+'" data-columnId="'+e+'">'+(o.receive?"已领取":"立即领取")+"</span>                </div>            </div>";k.columnCouponBox.html(a),k.columnCouponBox.css({display:"flex"})}}function m(o,e,a){$.ajax({type:"GET",url:blogUrl+o,dataType:"json",xhrFields:{withCredentials:!0},data:{columnId:a},success:function(o){200==o.code?b(o.data,a):e.remove()},error:function(o){e.remove()}})}function f(o,e,a){$.ajax({type:"GET",url:blogUrl+o,dataType:"json",xhrFields:{withCredentials:!0},data:{columnId:a},success:function(n){200==n.code?n.data?(e.find(".column_coupon_main").addClass("active"),e.find(".column_coupon_r").html("已领取"),I?r(a):i(a)):setTimeout(function(){f(o,e,a)},500):showToast({text:n.message||"操作失败，请重试！",bottom:"10%",zindex:9e3,speed:500,time:1500})},error:function(o){showToast({text:o.message||"操作失败，请重试！",bottom:"10%",zindex:9e3,speed:500,time:1500})}})}function g(o,e,a){$.ajax({url:blogUrl+o,type:"post",dataType:"json",data:{columnId:a,groupNumber:e},xhrFields:{withCredentials:!0},success:function(o){200==o.code&&o.data?f(k.columnCouponStatus,k.columnCouponBox,a):showToast({text:o.message||"操作失败，请重试！",bottom:"10%",zindex:9e3,speed:500,time:1500})},error:function(o){showToast({text:o.message||"操作失败，请重试！",bottom:"10%",zindex:9e3,speed:500,time:1500})}})}var x=0,y=0,h="",v="",w=0,_="";$(document).on("click",".tip-subscribe-column>span",function(){$(this).parent().find(".tip").fadeIn()}),$(document).on("click",".tip-subscribe-column .bt-close",function(){$(".tip-subscribe-column").find(".tip").fadeOut()});var C="",k={boxshadow:$(".skin-boxshadow"),btClose:$(".bt-close"),payCode:$(".pay-code"),btSubscribe:$(".bt-subscribe-article"),btSubscribeColumn:$(".bt-subscribe-text"),getPay:$(".get-pay"),columnCouponBox:$("#columnCouponBox"),columnCouponCheck:"phoenix/web/v1/coupon/check-column-coupon",columnCouponStatus:"phoenix/web/v1/coupon/get-column-coupon-status",columnCouponLook:"phoenix/web/v1/coupon/get-column-coupon"},I=!1,B=window.location.href;B.indexOf("category_")>-1&&(k.columnCouponBox.length&&(C=k.columnCouponBox.data("id"),m(k.columnCouponCheck,k.columnCouponBox,C)),k.getPay.length&&(I=!1,C=k.getPay.data("id"),getCookie("UserName")&&(_=p("sale_source"),i(C)))),B.indexOf("/article/details/")>-1&&k.columnCouponBox.length&&(I=!0,C=k.columnCouponBox.data("id"),m(k.columnCouponCheck,k.columnCouponBox,C)),$(document).on("click",".bt-subscribe",function(){getCookie("UserName")||window.csdn.loginBox.show()}),k.getPay.on("click",function(){I=!1,C=$(this).data("id"),e(C)}),k.payCode.on("click",".renovate",function(){e(C||$(this).parent().data("id"))}),k.btClose.on("click",function(){k.payCode.fadeOut(function(){k.boxshadow.fadeOut()})});var T=blogStaticHost+"dist/pc/img/pay-time-out.png",N="获取中",z='<img class="repeat-again" src="'+T+'"><span class="text">'+N+"</span>",O='<div class="renov-men"><img src="'+T+'"><span>'+N+"</span></div>",U='<div class="renovate">    <img src="'+blogStaticHost+'dist/pc/img/pay-time-out.png">    <span>点击重新获取</span></div>',j='<img class="repeat-again" src="'+blogStaticHost+'dist/pc/img/pay-time-out.png"><span class="text">点击重新获取</span>';$(".now-price").text();$(".pay-code-radio").click(function(){var o=$(this).attr("data-flag");"true"==o?(x=0,$(this).attr("data-flag","false"),$(this).prop("checked",!1)):(x=1,$(this).attr("data-flag","true"),$(this).prop("checked",!0)),i(C)});var E=$(".subscribe-price .now-price").text().slice(1),P=0;k.payCode.on("click",".blance-bt",function(){window.open(h)}),$(document).on("click",".articleColumnBt",function(){if(getCookie("UserName")){var o=$(this).data("id");r(o)}else window.csdn.loginBox.show()}),$(document).on("click",".column-studyvip-pass",function(){getCookie("UserName")?window.open("https://mall.csdn.net/vip?vipSource=learningVip"):window.csdn.loginBox.show()}),$(document).on("click",".column-studyvip-ajax",d),$(document).on("click","#columnCouponBox",function(o){if(getCookie("UserName")){if("column_coupon_r"==o.target.className&&!$(this).find(".column_coupon_main").hasClass("active")){var e=o.target.dataset.couponid,a=o.target.dataset.columnid;g(k.columnCouponLook,e,a)}}else window.csdn.loginBox.show()})});